#!/usr/bin/python

import argparse
import urllib2
import json
import DiffieHellman
import commands
import subprocess

# openssl dgst -sha256 -sign ~/.ssh/id_rsa f > f.sign

dh = DiffieHellman.DiffieHellman()
# print(dh.publicKey)

response = urllib2.urlopen('http://localhost:8001/dh', json.dumps({ 'cl-pub' : dh.publicKey }))
svPublicKey = json.load(response)['sv-pub']

shared = dh.genSecret(dh.privateKey, svPublicKey)

_, sig = commands.getstatusoutput('echo -n "' + str(shared) + '" | openssl dgst -sha256 -hex -sign ~/.ssh/id_rsa')
print(shared)
response = urllib2.urlopen('http://localhost:8001/sign', json.dumps({ 'cl-sig' : sig }))
svSignResponse = json.load(response)

print(svSignResponse)

'''
parser = argparse.ArgumentParser(description='User configuration utility')

response = urllib2.urlopen('http://localhost:8000/info')
data = json.load(response)

subparsers = parser.add_subparsers(title='commands', help='-h gives command help')

for command in data['response']:
  subparser = subparsers.add_parser(command['name'], help='Help for command')

  for option in command['options']:
    subparser.add_argument('--' + option['name'], help=option['description'])

args = parser.parse_args()
'''
